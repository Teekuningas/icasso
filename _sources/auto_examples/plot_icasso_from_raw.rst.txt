.. note::
    :class: sphx-glr-download-link-note

    Click :ref:`here <sphx_glr_download_auto_examples_plot_icasso_from_raw.py>` to download the full example code
.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_icasso_from_raw.py:


.. _tut_icasso:

Use Icasso to compute and validate ICA on MEG data
============================================

ICA is fit to MEG raw data multiple times, and the performance is then visually inspected. Finally the components are retrieved as centrotypes of the most robust clusters.



.. code-block:: python

    # Authors: Erkka Heinila <erkka.heinila@jyu.fi>
    #
    # License: BSD (3-clause)

    import logging

    import numpy as np
    import matplotlib.pyplot as plt
    import mne

    from mne.preprocessing import ICA
    from mne.preprocessing import create_ecg_epochs, create_eog_epochs
    from mne.datasets import sample

    from icasso import Icasso







Set up logging



.. code-block:: python

    logging.basicConfig(level=logging.INFO)







Setup paths and prepare raw data.



.. code-block:: python

    data_path = sample.data_path()
    raw_fname = data_path + '/MEG/sample/sample_audvis_filt-0-40_raw.fif'

    raw = mne.io.read_raw_fif(raw_fname, preload=True)
    raw.filter(1, None, fir_design='firwin')

    picks = mne.pick_types(raw.info, meg='grad', eeg=False, eog=False,
                           stim=False, exclude='bads')
    raw.drop_channels([ch_name for idx, ch_name in enumerate(raw.info['ch_names'])
                       if idx not in picks])





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Opening raw data file /home/zairex/.virtualenvs/mne2/lib/python2.7/site-packages/examples/MNE-sample-data/MEG/sample/sample_audvis_filt-0-40_raw.fif...
        Read a total of 4 projection items:
            PCA-v1 (1 x 102)  idle
            PCA-v2 (1 x 102)  idle
            PCA-v3 (1 x 102)  idle
            Average EEG reference (1 x 60)  idle
        Range : 6450 ... 48149 =     42.956 ...   320.665 secs
    Ready.
    Current compensation grade : 0
    Reading 0 ... 41699  =      0.000 ...   277.709 secs...
    Setting up high-pass filter at 1 Hz
    l_trans_bandwidth chosen to be 1.0 Hz
    Filter length of 497 samples (3.310 sec) selected


Plot raw data



.. code-block:: python

    raw.plot(block=True)




.. image:: /auto_examples/images/sphx_glr_plot_icasso_from_raw_001.png
    :class: sphx-glr-single-img




Define parameters for mne's ICA-object and create a Icasso object.
Set bootstrap=True to use bootstrapping.



.. code-block:: python

    ica_params = {
        'n_components':20,
        'method': 'fastica',
        'max_iter': 1000,
    }
    icasso = Icasso(ICA, ica_params=ica_params, iterations=20, 
                    bootstrap=False, vary_init=True)







Set up params for ICA.fit method.



.. code-block:: python

    fit_params = {
        'decim': 3,
        'verbose': 'warning'
    }







Set up function for getting bootstrapped versions of Raw object.



.. code-block:: python

    def bootstrap_fun(raw, generator):
        sample_idxs = generator.choice(range(raw._data.shape[1]), size=raw._data.shape[1])
        raw = raw.copy()
        raw._data = raw._data[:, sample_idxs]
        return raw







Set up function to get unmixing matrix from mne's ICA object after fitting.



.. code-block:: python

    def unmixing_fun(ica):
        unmixing_matrix = np.dot(ica.unmixing_matrix_, 
                                 ica.pca_components_[:ica.n_components_])
        return unmixing_matrix







Set up function to store information about individual runs. 
We do this to get pca mean and pre_whiten information.



.. code-block:: python

    def store_fun(ica):
        data = {'pre_whitener': ica.pre_whitener_,
                'pca_mean': ica.pca_mean_[:, np.newaxis]}
        return data







For replicability



.. code-block:: python

    random_state = 10
    distance = 0.75







Fit icasso to raw data.



.. code-block:: python

    icasso.fit(data=raw, fit_params=fit_params, random_state=random_state, 
               bootstrap_fun=bootstrap_fun, unmixing_fun=unmixing_fun, 
               store_fun=store_fun)







Plot a dendogram



.. code-block:: python

    icasso.plot_dendrogram()




.. image:: /auto_examples/images/sphx_glr_plot_icasso_from_raw_002.png
    :class: sphx-glr-single-img




Plot the components in 2D space.



.. code-block:: python

    icasso.plot_mds(distance=distance, random_state=random_state)




.. image:: /auto_examples/images/sphx_glr_plot_icasso_from_raw_003.png
    :class: sphx-glr-single-img




Unmix using the centrotypes



.. code-block:: python

    unmixing, scores = icasso.get_centrotype_unmixing(distance=distance)
    pca_mean, pre_whitener = icasso.store[0]['pca_mean'], icasso.store[0]['pre_whitener']
    sources = np.dot(unmixing, (raw._data / pre_whitener) - pca_mean)







Show cluster quality indices.



.. code-block:: python

    plt.figure()
    plt.plot(range(1, len(scores)+1), scores)
    plt.xticks(range(1, len(scores)+1), 
               [str(idx) for idx in range(1, len(scores)+1)])
    plt.xlabel('Component')
    plt.ylabel('Quality index')
    plt.show()




.. image:: /auto_examples/images/sphx_glr_plot_icasso_from_raw_004.png
    :class: sphx-glr-single-img




Create raw object using the icasso centrotype sources and plot it



.. code-block:: python

    sources = sources * 3e-04
    info = mne.create_info(['ICA %03d' % idx for idx in range(sources.shape[0])], 
                           raw.info['sfreq'], ch_types='misc')
    components = mne.io.RawArray(sources, info)
    components.plot(block=True)



.. image:: /auto_examples/images/sphx_glr_plot_icasso_from_raw_005.png
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Creating RawArray with float64 data, n_channels=21, n_times=41700
        Range : 0 ... 41699 =      0.000 ...   277.709 secs
    Ready.


**Total running time of the script:** ( 0 minutes  25.691 seconds)


.. _sphx_glr_download_auto_examples_plot_icasso_from_raw.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_icasso_from_raw.py <plot_icasso_from_raw.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_icasso_from_raw.ipynb <plot_icasso_from_raw.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
